<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bandcamp Yum Check</title>

    <style>
        .loader {
            border: 6px solid #f3f3f3;
            /* Light grey */
            border-top: 6px solid #3498db;
            /* Blue */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

</head>

<body>


    <div id="warning-header">
        <h4>Warning</h4>
        <p>This tool uses a public CORS proxy to send requests to Bandcamp.</p>
        <p>Use at your own risk and don't overuse without reason to avoid it getting blocked. Thanks.</p>
    </div>

    <div id="info-header">
        <h4>Info</h4>
        <p>This tool bulk-checks Bandcamp yum codes.</p>
        <p id="info-js">JavaScript needs to be enabled for the tool to work.</p>
    </div>

    <div style="margin-top:2em;">
        <h4>Yummy!</h4>

        <textarea id="bandcamp" cols="30" rows="10" placeholder="Enter one Bandcamp code per line..."></textarea>
    </div>


    <div>
        <div class="loader" style="display: none;"></div>

        <p id="msg-good" style="display: none;">Good to go :)</p>
        <p id="msg-bad" style="display: none;">No valid codes found :(</p>
        <ul id="valid-list">
        </ul>

    </div>



    <script>

        var infoJs = document.getElementById("info-js");
        infoJs.style.display = "none";

        if (typeof (String.prototype.trim) === "undefined") {
            String.prototype.trim = function () {
                return String(this).replace(/^\s+|\s+$/g, '');
            };
        }

        async function checkCode(code) {
            try {
                const response = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent('https://bandcamp.com/api/codes/1/verify'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        'is_corp': true,
                        'code': code
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const jsonResponse = await response.json();
                return jsonResponse;
            } catch (error) {
                console.error("Error in fetch request:", error);
                return null;
            }
        }

        var bandcamp = document.getElementById("bandcamp");
        bandcamp.addEventListener("input", async function () {
            var bandcampText = bandcamp.value;
            var bandcampArray = bandcampText.split("\n").filter((item, pos, self) => {
                return self.indexOf(item) === pos && item.trim() !== "" && item.indexOf(" ") === -1 && item.indexOf("-") !== -1 && item.trim().length === 9;
            });

            var validList = document.getElementById("valid-list");
            var msgGood = document.getElementById("msg-good");
            var msgBad = document.getElementById("msg-bad");
            var loader = document.getElementsByClassName("loader")[0];

            validList.innerHTML = "";
            msgGood.style.display = "none";
            msgBad.style.display = "none";
            loader.style.display = "block";

            var validCodesFound = false;

            for (let i = 0; i < bandcampArray.length; i++) {
                if (i > 0 && i % 14 === 0) {
                    await new Promise(r => setTimeout(r, 5000));
                }

                const jsonResponse = await checkCode(bandcampArray[i]);

                if (jsonResponse && jsonResponse.ok) {
                    validCodesFound = true;

                    if (msgGood.style.display === "none") {
                        msgGood.style.display = "block";
                    }

                    var li = document.createElement("li");
                    var a = document.createElement("a");
                    a.setAttribute("href", "https://bandcamp.com/yum?code=" + bandcampArray[i]);
                    a.appendChild(document.createTextNode(bandcampArray[i]));
                    li.appendChild(a);
                    validList.appendChild(li);
                } else if (jsonResponse && jsonResponse.errors && jsonResponse.errors.some(error => error.reason === "invalid.already_redeemed")) {
                    console.log("Code already redeemed: " + bandcampArray[i]);
                } else {
                    console.log("Invalid code: " + bandcampArray[i]);
                }
            }

            if (!validCodesFound) {
                msgBad.style.display = "block";
            }

            loader.style.display = "none";
        });

    </script>
</body>

</html>
